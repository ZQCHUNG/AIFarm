<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>V2.0 Isometric Engine — Entity Manager Demo</title>
  <style>
    body { background: #1a1a2e; padding: 20px; font-family: monospace; color: #ccc; margin: 0; }
    h1 { font-size: 16px; color: #6CB0E8; margin: 10px 20px; }
    p { font-size: 12px; margin: 4px 20px; color: #888; }
    canvas { display: block; border-radius: 8px; border: 1px solid #333; margin: 10px 20px; }
    .controls { margin: 10px 20px; font-size: 11px; color: #666; }
    kbd { background: #333; padding: 2px 6px; border-radius: 3px; color: #aaa; }
  </style>
</head>
<body>
  <h1>V2.0 Isometric Engine — Entity Manager Demo</h1>
  <p>IsoEntityManager: AI-driven animals, path-following characters, depth-sorted rendering</p>
  <canvas id="iso-canvas" width="640" height="480"></canvas>
  <div class="controls">
    <kbd>Arrow Keys</kbd> Pan camera &nbsp;
    <kbd>1-7</kbd> Paint tile type &nbsp;
    <kbd>Click</kbd> Place tile &nbsp;
    <kbd>Scroll</kbd> Zoom in/out &nbsp;
    <kbd>V</kbd> Cycle vibe mood
  </div>

  <script src="sprite-manager.js"></script>
  <script src="animal-ai.js"></script>
  <script src="iso-engine.js"></script>
  <script src="iso-entity-manager.js"></script>
  <script>
    const canvas = document.getElementById('iso-canvas');
    const ctx = canvas.getContext('2d');

    // Build a 16x16 demo farm map
    IsoEngine.initMap(16, 16, 'grass');

    // Dirt path through the middle
    for (let i = 0; i < 16; i++) {
      IsoEngine.setTile(i, 7, 'path');
      IsoEngine.setTile(i, 8, 'path');
    }

    // Farm plots (soil patches)
    for (let r = 3; r <= 5; r++) {
      for (let c = 2; c <= 6; c++) IsoEngine.setTile(c, r, 'soil');
    }
    for (let r = 3; r <= 5; r++) {
      for (let c = 9; c <= 13; c++) IsoEngine.setTile(c, r, 'soil');
    }

    // Pond
    for (let r = 10; r <= 12; r++) {
      for (let c = 2; c <= 5; c++) IsoEngine.setTile(c, r, 'water');
    }

    // Stone area (quarry)
    for (let r = 10; r <= 12; r++) {
      for (let c = 10; c <= 13; c++) IsoEngine.setTile(c, r, 'stone');
    }

    // Sand border around pond
    [[1,10],[1,11],[1,12],[6,10],[6,11],[6,12],
     [2,9],[3,9],[4,9],[5,9],[2,13],[3,13],[4,13],[5,13]].forEach(([c,r]) => {
      IsoEngine.setTile(c, r, 'sand');
    });

    // ===== Use IsoEntityManager for all entities =====

    // Trees (static entities)
    const treePositions = [
      [0,0],[1,1],[14,1],[15,0],[0,14],[15,15],
      [7,0],[8,0],[0,6],[15,6],[0,9],[15,9],
      [7,14],[8,15],[14,14],
    ];
    for (const [c, r] of treePositions) {
      IsoEntityManager.add(IsoEntityManager.createStatic(c, r,
        (ctx, sx, sy, tick) => IsoEngine.drawIsoTree(ctx, sx, sy, tick)
      ));
    }

    // Crops (static entities)
    const cropPositions = [
      { c: 3, r: 3, stage: 4, color: '#FF8C00' },
      { c: 4, r: 3, stage: 3, color: '#FFD700' },
      { c: 5, r: 3, stage: 2, color: '#2E8B57' },
      { c: 3, r: 4, stage: 4, color: '#FF4444' },
      { c: 4, r: 4, stage: 1, color: '#F0E68C' },
      { c: 5, r: 4, stage: 3, color: '#FF7518' },
      { c: 3, r: 5, stage: 4, color: '#FFD700' },
      { c: 4, r: 5, stage: 2, color: '#FF8C00' },
      { c: 5, r: 5, stage: 4, color: '#2E8B57' },
      { c: 10, r: 3, stage: 3, color: '#FF4444' },
      { c: 11, r: 3, stage: 4, color: '#F0E68C' },
      { c: 12, r: 3, stage: 2, color: '#FF7518' },
      { c: 10, r: 4, stage: 4, color: '#FF8C00' },
      { c: 11, r: 4, stage: 3, color: '#FFD700' },
      { c: 12, r: 4, stage: 1, color: '#2E8B57' },
      { c: 10, r: 5, stage: 2, color: '#FF4444' },
      { c: 11, r: 5, stage: 4, color: '#FF7518' },
      { c: 12, r: 5, stage: 3, color: '#F0E68C' },
    ];
    for (const crop of cropPositions) {
      IsoEntityManager.add(IsoEntityManager.createStatic(crop.c, crop.r,
        (ctx, sx, sy, tick) => IsoEngine.drawIsoCrop(ctx, sx, sy, crop.stage, crop.color, tick)
      ));
    }

    // Walking character (path following via IsoEntityManager)
    const walker = IsoEntityManager.add(IsoEntityManager.createCharacter(7, 6, {
      hoodieColor: '#6C5CE7',
      name: 'Walker',
      path: [
        { col: 7, row: 6, dir: 'down' },
        { col: 7, row: 7, dir: 'down' },
        { col: 8, row: 7, dir: 'right' },
        { col: 9, row: 7, dir: 'right' },
        { col: 10, row: 7, dir: 'right' },
        { col: 10, row: 8, dir: 'down' },
        { col: 10, row: 9, dir: 'down' },
        { col: 9, row: 9, dir: 'left' },
        { col: 8, row: 9, dir: 'left' },
        { col: 7, row: 9, dir: 'left' },
        { col: 7, row: 8, dir: 'up' },
        { col: 7, row: 7, dir: 'up' },
        { col: 7, row: 6, dir: 'up' },
      ],
      pathInterval: 30,
    }));

    // Standing character
    IsoEntityManager.add(IsoEntityManager.createCharacter(4, 7, {
      hoodieColor: '#E84393',
      name: 'Farmer',
      direction: 'right',
    }));

    // ===== AI-driven animals (2D isometric behavior tree) =====
    const animalDefs = [
      { type: 'chicken', col: 8,  row: 11, radius: 2.5 },
      { type: 'cow',     col: 12, row: 13, radius: 2.0 },
      { type: 'pig',     col: 6,  row: 13, radius: 1.8 },
      { type: 'sheep',   col: 10, row: 14, radius: 2.0 },
      { type: 'cat',     col: 3,  row: 6,  radius: 1.5 },
      { type: 'dog',     col: 13, row: 6,  radius: 3.0 },
    ];
    for (const def of animalDefs) {
      IsoEntityManager.add(IsoEntityManager.createAnimal(def.type, def.col, def.row, {
        wanderRadius: def.radius,
        minCol: 0, maxCol: 15, minRow: 0, maxRow: 15,
      }));
    }

    // Vibe mood cycling (press V to change)
    const moods = ['calm', 'happy', 'cautious', 'huddled'];
    let moodIndex = 0;
    IsoEntityManager.setAnimalMood(moods[moodIndex]);

    // Center camera
    IsoEngine.centerOnTile(8, 8, canvas.width, canvas.height);

    // Keyboard
    const keys = {};
    document.addEventListener('keydown', (e) => { keys[e.key] = true; });
    document.addEventListener('keyup', (e) => { keys[e.key] = false; });

    // Tile painting
    let paintTile = null;
    const tileKeys = { '1': 'grass', '2': 'dirt', '3': 'soil', '4': 'water', '5': 'stone', '6': 'sand', '7': 'path' };
    document.addEventListener('keydown', (e) => {
      if (tileKeys[e.key]) paintTile = tileKeys[e.key];
      if (e.key === 'v' || e.key === 'V') {
        moodIndex = (moodIndex + 1) % moods.length;
        IsoEntityManager.setAnimalMood(moods[moodIndex]);
      }
    });

    canvas.addEventListener('click', (e) => {
      if (!paintTile) return;
      const rect = canvas.getBoundingClientRect();
      const mx = (e.clientX - rect.left) / IsoEngine.getZoom();
      const my = (e.clientY - rect.top) / IsoEngine.getZoom();
      const { col, row } = IsoEngine.screenToGrid(mx, my);
      if (col >= 0 && col < 16 && row >= 0 && row < 16) {
        IsoEngine.setTile(col, row, paintTile);
      }
    });

    // Mouse wheel zoom
    canvas.addEventListener('wheel', (e) => {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const mx = e.clientX - rect.left;
      const my = e.clientY - rect.top;
      const delta = e.deltaY < 0 ? 1 : -1;
      IsoEngine.zoom(delta, mx / IsoEngine.getZoom(), my / IsoEngine.getZoom());
    }, { passive: false });

    // Animation loop
    let tick = 0;
    function loop() {
      tick++;

      // Camera panning
      const PAN_SPEED = 3;
      if (keys['ArrowLeft']) IsoEngine.moveCamera(PAN_SPEED, 0);
      if (keys['ArrowRight']) IsoEngine.moveCamera(-PAN_SPEED, 0);
      if (keys['ArrowUp']) IsoEngine.moveCamera(0, PAN_SPEED);
      if (keys['ArrowDown']) IsoEngine.moveCamera(0, -PAN_SPEED);

      // Update all entities via IsoEntityManager
      IsoEntityManager.update(tick);

      // Sync managed entities → IsoEngine for depth-sorted rendering
      IsoEntityManager.syncToEngine();

      // Clear
      ctx.fillStyle = '#1a1a2e';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Sky gradient
      const skyGrad = ctx.createLinearGradient(0, 0, 0, canvas.height * 0.4);
      skyGrad.addColorStop(0, '#87CEEB');
      skyGrad.addColorStop(1, '#E0F0FF');
      ctx.fillStyle = skyGrad;
      ctx.fillRect(0, 0, canvas.width, canvas.height * 0.4);

      // Ground fill
      ctx.fillStyle = '#4A7A3A';
      ctx.fillRect(0, canvas.height * 0.35, canvas.width, canvas.height * 0.65);

      // Draw isometric map (tiles + all entities, depth-sorted)
      IsoEngine.drawMap(ctx, canvas.width, canvas.height, tick);

      // HUD
      ctx.fillStyle = 'rgba(0,0,0,0.6)';
      ctx.fillRect(canvas.width - 200, 8, 192, 64);
      ctx.fillStyle = '#6CB0E8';
      ctx.font = '12px monospace';
      ctx.fillText('V2.0 ISO ENTITY MANAGER', canvas.width - 190, 24);
      ctx.fillStyle = '#888';
      ctx.font = '10px monospace';
      ctx.fillText(`Tile: ${paintTile || 'none'}  Zoom: ${IsoEngine.getZoom().toFixed(1)}x`, canvas.width - 190, 38);
      const animals = IsoEntityManager.getByType('animal');
      const activeCount = animals.filter(a => a.state !== 'rest').length;
      ctx.fillText(`Animals: ${animals.length} (${activeCount} active)`, canvas.width - 190, 50);
      ctx.fillStyle = moods[moodIndex] === 'happy' ? '#FFD700' : moods[moodIndex] === 'cautious' ? '#FF8800' : moods[moodIndex] === 'huddled' ? '#FF4444' : '#6CB0E8';
      ctx.fillText(`Vibe: ${moods[moodIndex]} [V]`, canvas.width - 190, 62);

      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);
  </script>
</body>
</html>
