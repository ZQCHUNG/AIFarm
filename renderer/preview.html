<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Claude Buddy Farm Preview — Harvest Moon Style</title>
  <style>
    body { background: #1a1a2e; padding: 20px; font-family: monospace; color: #ccc; }
    h2 { margin: 12px 0 6px; font-size: 14px; }
    canvas { display: block; border-radius: 8px; border: 1px solid #333; image-rendering: pixelated; margin-bottom: 16px; }
    .info { font-size: 11px; color: #888; margin-bottom: 12px; }
  </style>
</head>
<body>
  <script src="speech-bubble.js"></script>
  <script src="scene.js"></script>
  <script src="viewport.js"></script>
  <script src="sprite-manager.js"></script>
  <script src="animal-ai.js"></script>
  <script src="iso-engine.js"></script>
  <script src="iso-entity-manager.js"></script>
  <script src="farm.js"></script>
  <script src="iso-farm.js"></script>
  <script src="iso-train.js"></script>
  <script src="iso-weather.js"></script>
  <script src="iso-tooltip.js"></script>
  <script src="character.js"></script>
  <script src="train.js"></script>
  <script src="state-machine.js"></script>
  <script>
    // ===== Mock farm state =====
    const mockFarmState = {
      totalEnergy: 2800,
      milestoneReached: 2500,
      plots: [
        { crop: 'carrot', stage: 4, growthProgress: 0 },
        { crop: 'sunflower', stage: 3, growthProgress: 10 },
        { crop: 'watermelon', stage: 4, growthProgress: 0 },
        { crop: 'tomato', stage: 2, growthProgress: 5 },
        { crop: 'corn', stage: 3, growthProgress: 12 },
        { crop: 'carrot', stage: 1, growthProgress: 0 },
        { crop: 'sunflower', stage: 4, growthProgress: 0 },
        { crop: 'pumpkin', stage: 2, growthProgress: 8 },
        { crop: 'watermelon', stage: 3, growthProgress: 15 },
        { crop: null, stage: 0, growthProgress: 0 },
        { crop: null, stage: 0, growthProgress: 0 },
        { crop: null, stage: 0, growthProgress: 0 },
      ],
      animals: {
        chicken: { unlocked: true, homeX: 25 },
        cow: { unlocked: true, homeX: 50 },
        pig: { unlocked: true, homeX: 75 },
        sheep: { unlocked: true, homeX: 40 },
        cat: { unlocked: true, homeX: 60 },
      },
      buildings: {
        well: true,
        barn: true,
        windmill: true,
        market: true,
      },
      unlockedCrops: ['carrot', 'sunflower', 'watermelon', 'tomato', 'corn', 'pumpkin'],
      totalHarvests: 23,
      achievements: [],
    };
    Farm.setState(mockFarmState);

    Farm.setVibe({
      timestamp: new Date().toISOString(),
      vibeScore: 0.78,
      mood: 'productive',
      metrics: { eventsPerMinute: 8.5, errorRate: 0.05, toolDiversity: 6, totalEvents: 42, dominantActivity: 'writing' },
      atmosphere: { skyTint: 'warm', animalMood: 'happy', lampLit: false, groundTint: null },
    });

    Farm.setUsage({
      liveOutput: 12450, liveInput: 3200, liveCacheRead: 850000, liveMessages: 42,
      todayTokens: 245000, todayMessages: 186,
      totalOutput: 3169853, totalInput: 277993, totalCacheRead: 2280936596,
      totalSessions: 121, totalMessages: 98320,
    });

    // ===== Top-Down Farm Demo (Harvest Moon style) =====
    const h1 = document.createElement('h2');
    h1.textContent = 'Top-Down Farm — Harvest Moon Style';
    document.body.appendChild(h1);

    const info = document.createElement('div');
    info.className = 'info';
    info.textContent = 'Arrow keys: pan camera | Mouse wheel: zoom | Hover tiles for highlight';
    document.body.appendChild(info);

    const baseW = 660;
    const baseH = 500;
    const c1 = document.createElement('canvas');
    c1.width = baseW;
    c1.height = baseH;
    c1.style.width = baseW + 'px';
    c1.style.height = baseH + 'px';
    c1.id = 'farm-canvas';
    document.body.appendChild(c1);
    const fCtx = c1.getContext('2d');

    // Initialize top-down engine + farm
    IsoFarm.init();
    IsoFarm.syncState();

    // Add demo buddies
    const demoBuddies = [
      { id: 'b1', project: 'AIFarm', colorIndex: 0 },
      { id: 'b2', project: 'Stock', colorIndex: 1 },
      { id: 'b3', project: 'kisame', colorIndex: 3 },
    ];
    for (const b of demoBuddies) {
      IsoFarm.syncBuddy(b.id, b.project, b.colorIndex, 'working');
    }

    // Camera state for mouse interaction
    let hoverCol = -1, hoverRow = -1;

    c1.addEventListener('mousemove', (e) => {
      const rect = c1.getBoundingClientRect();
      const mx = e.clientX - rect.left;
      const my = e.clientY - rect.top;
      const grid = IsoEngine.mouseToGrid(mx, my);
      IsoEngine.setHoverTile(grid.col, grid.row);
      if (typeof IsoTooltip !== 'undefined') {
        IsoTooltip.updateHover(grid.col, grid.row, new Map(), []);
      }
    });
    c1.addEventListener('mouseleave', () => {
      IsoEngine.setHoverTile(-1, -1);
    });
    c1.addEventListener('wheel', (e) => {
      e.preventDefault();
      const rect = c1.getBoundingClientRect();
      const mx = e.clientX - rect.left;
      const my = e.clientY - rect.top;
      const delta = e.deltaY < 0 ? 1 : -1;
      IsoEngine.zoom(delta, mx / IsoEngine.getZoom(), my / IsoEngine.getZoom());
    }, { passive: false });

    // Arrow key panning
    const farmKeys = {};
    document.addEventListener('keydown', (e) => { farmKeys[e.key] = true; });
    document.addEventListener('keyup', (e) => { farmKeys[e.key] = false; });

    let farmTick = 0;
    function farmLoop() {
      farmTick++;

      // Camera pan
      const PAN_SPEED = 4;
      if (farmKeys['ArrowLeft']) IsoEngine.moveCamera(PAN_SPEED, 0);
      if (farmKeys['ArrowRight']) IsoEngine.moveCamera(-PAN_SPEED, 0);
      if (farmKeys['ArrowUp']) IsoEngine.moveCamera(0, PAN_SPEED);
      if (farmKeys['ArrowDown']) IsoEngine.moveCamera(0, -PAN_SPEED);

      // Update entities
      IsoEntityManager.update(farmTick);
      IsoEntityManager.syncToEngine();

      // Clear with sky gradient
      const skyGrad = fCtx.createLinearGradient(0, 0, 0, baseH);
      skyGrad.addColorStop(0, '#87CEEB');
      skyGrad.addColorStop(0.25, '#B8E0F0');
      skyGrad.addColorStop(0.4, '#6EBF4E');
      skyGrad.addColorStop(1, '#4E9E38');
      fCtx.fillStyle = skyGrad;
      fCtx.fillRect(0, 0, baseW, baseH);

      // Weather
      if (typeof IsoWeather !== 'undefined') {
        const vibe = Farm.getVibe();
        if (vibe) IsoWeather.setMood(vibe.mood, vibe.vibeScore || 0);
        IsoWeather.update(farmTick, baseW, baseH);
      }

      // Render map + entities
      IsoEngine.drawMap(fCtx, baseW, baseH, farmTick);

      // Weather overlay
      if (typeof IsoWeather !== 'undefined') {
        IsoWeather.draw(fCtx, baseW, baseH, farmTick);
      }

      // Tooltips
      if (typeof IsoTooltip !== 'undefined') {
        IsoTooltip.draw(fCtx, baseW, baseH, farmTick);
      }

      // HUD
      IsoFarm.drawHUD(fCtx, baseW, baseH, farmTick);

      requestAnimationFrame(farmLoop);
    }
    requestAnimationFrame(farmLoop);

    // ===== Classic Side-View Demo (for comparison) =====
    const h2el = document.createElement('h2');
    h2el.textContent = 'Classic Side-View (Ctrl+Shift+I to toggle in app)';
    document.body.appendChild(h2el);

    const SCALE = 2;
    const margin = 15;
    const buddies = [
      { name: '~', state: 'bash', detail: '$ npm test' },
      { name: 'Stock', state: 'writing', detail: '' },
      { name: 'anya', state: 'reading', detail: '' },
      { name: 'kisame', state: 'thinking', detail: '' },
      { name: 'Dog', state: 'sleeping', detail: '' },
    ];
    const slotW = 40;
    const classicW = Math.max(330, buddies.length * slotW * Scene.PX + margin * 2 * Scene.PX + 90);
    const classicH = 351;

    const c2 = document.createElement('canvas');
    c2.width = classicW;
    c2.height = classicH;
    c2.style.width = classicW + 'px';
    c2.style.height = classicH + 'px';
    document.body.appendChild(c2);
    const cCtx = c2.getContext('2d');

    Train.setStationBuilt(true);
    setTimeout(() => { Train.queueArrival('newcomer', 3); }, 2000);

    let classicTick = 0;
    function classicLoop() {
      classicTick++;
      cCtx.clearRect(0, 0, classicW, classicH);
      Scene.drawBackground(cCtx, classicW, classicTick);
      Farm.drawFarm(cCtx, classicW, classicTick);
      Train.update(classicTick);
      Train.draw(cCtx, Math.ceil(classicW / Scene.PX), classicTick);

      const logW = Math.ceil(classicW / Scene.PX);
      const usable = logW - margin * 2;
      const sw = Math.min(40, Math.floor(usable / buddies.length));

      buddies.forEach((b, i) => {
        const sx = margin + i * sw;
        const frame = ((classicTick / 14) | 0) % 4;
        Scene.drawStation(cCtx, sx, b.state, classicTick + i * 50);
        Character.draw(cCtx, sx, b.state, frame, classicTick + i * 30, i);
        const hc = Character.HOODIE_COLORS[i % Character.HOODIE_COLORS.length];
        Scene.drawNameplate(cCtx, (sx + sw / 2) * Scene.PX, b.name, hc.o);
        if (b.detail) {
          SpeechBubble.draw(cCtx, b.detail, (sx + 10) * Scene.PX, (Scene.GROUND_Y - 15) * Scene.PX);
        }
      });
      requestAnimationFrame(classicLoop);
    }
    requestAnimationFrame(classicLoop);
  </script>
</body>
</html>
