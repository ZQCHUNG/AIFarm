<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Claude Buddy Village Preview</title>
  <style>
    body { background: #1a1a2e; padding: 20px; font-family: monospace; color: #ccc; }
    h2 { margin: 12px 0 6px; font-size: 14px; }
    canvas { display: block; border-radius: 8px; border: 1px solid #333; image-rendering: pixelated; margin-bottom: 16px; }
  </style>
</head>
<body>
  <script src="speech-bubble.js"></script>
  <script src="scene.js"></script>
  <script src="viewport.js"></script>
  <script src="animal-ai.js"></script>
  <script src="farm.js"></script>
  <script src="character.js"></script>
  <script src="train.js"></script>
  <script src="state-machine.js"></script>
  <script>
    // Mock farm state for preview
    const mockFarmState = {
      totalEnergy: 2800,
      milestoneReached: 2500,
      plots: [
        { crop: 'carrot', stage: 4, growthProgress: 0 },
        { crop: 'sunflower', stage: 3, growthProgress: 10 },
        { crop: 'watermelon', stage: 4, growthProgress: 0 },
        { crop: 'tomato', stage: 2, growthProgress: 5 },
        { crop: 'corn', stage: 3, growthProgress: 12 },
        { crop: 'carrot', stage: 1, growthProgress: 0 },
        { crop: 'sunflower', stage: 4, growthProgress: 0 },
        { crop: 'pumpkin', stage: 2, growthProgress: 8 },
        { crop: 'watermelon', stage: 3, growthProgress: 15 },
        { crop: null, stage: 0, growthProgress: 0 },
        { crop: null, stage: 0, growthProgress: 0 },
        { crop: null, stage: 0, growthProgress: 0 },
      ],
      animals: {
        chicken: { unlocked: true, homeX: 25 },
        cow: { unlocked: true, homeX: 50 },
        pig: { unlocked: true, homeX: 75 },
        sheep: { unlocked: true, homeX: 40 },
        cat: { unlocked: true, homeX: 60 },
      },
      buildings: {
        well: true,
        barn: true,
        windmill: true,
        market: true,
      },
      unlockedCrops: ['carrot', 'sunflower', 'watermelon', 'tomato', 'corn', 'pumpkin'],
      totalHarvests: 23,
      achievements: [
        { id: 'refiner', title: 'The Refiner', icon: '\u{1F52C}', currentTier: 'gold', currentTierColor: '#FFD700', value: 62, nextTier: 'diamond', nextThreshold: 200 },
        { id: 'architect', title: 'The Architect', icon: '\u{1F3D7}', currentTier: 'silver', currentTierColor: '#C0C0C0', value: 8, nextTier: 'gold', nextThreshold: 15 },
        { id: 'burner', title: 'The Burner', icon: '\u{1F525}', currentTier: 'diamond', currentTierColor: '#B9F2FF', value: 520000, nextTier: null, nextThreshold: null },
        { id: 'nightOwl', title: 'Night Owl', icon: '\u{1F989}', currentTier: 'silver', currentTierColor: '#C0C0C0', value: 5, nextTier: 'gold', nextThreshold: 10 },
        { id: 'marathon', title: 'Marathon Runner', icon: '\u{1F3C3}', currentTier: 'gold', currentTierColor: '#FFD700', value: 6.2, nextTier: 'diamond', nextThreshold: 10 },
        { id: 'harvestMaster', title: 'Harvest Master', icon: '\u{1F33E}', currentTier: null, currentTierColor: null, value: 23, nextTier: 'silver', nextThreshold: 25 },
        { id: 'townBuilder', title: 'Town Builder', icon: '\u{1F3D8}', currentTier: 'silver', currentTierColor: '#C0C0C0', value: 4, nextTier: 'gold', nextThreshold: 5 },
        { id: 'collaborator', title: 'Team Player', icon: '\u{1F91D}', currentTier: null, currentTierColor: null, value: 2, nextTier: 'silver', nextThreshold: 3 },
        { id: 'earlyBird', title: 'Early Bird', icon: '\u{1F305}', currentTier: null, currentTierColor: null, value: 1, nextTier: 'silver', nextThreshold: 3 },
      ],
    };
    Farm.setState(mockFarmState);

    // Trigger a demo achievement notification after 3 seconds
    setTimeout(() => {
      Farm.showAchievementNotification({
        id: 'marathon',
        title: 'Marathon Runner',
        icon: '\u{1F3C3}',
        tier: 'gold',
        tierLabel: 'Gold',
        tierColor: '#FFD700',
      });
    }, 3000);

    // Trigger a demo prestige notification after 7 seconds
    setTimeout(() => {
      Farm.showPrestigeNotification({
        fromGen: 1,
        toGen: 2,
        label: 'Expansion',
        worldWidth: 400,
      });
    }, 7000);

    // Mock vibe state for preview
    Farm.setVibe({
      timestamp: new Date().toISOString(),
      vibeScore: 0.78,
      mood: 'productive',
      metrics: {
        eventsPerMinute: 8.5,
        errorRate: 0.05,
        toolDiversity: 6,
        totalEvents: 42,
        dominantActivity: 'writing',
      },
      atmosphere: {
        skyTint: 'warm',
        animalMood: 'happy',
        lampLit: false,
        groundTint: null,
      },
    });

    // Activate train station and trigger demo arrival after 2 seconds
    Train.setStationBuilt(true);
    setTimeout(() => {
      Train.queueArrival('newcomer', 3);
    }, 2000);
    // Second train at 10 seconds
    setTimeout(() => {
      Train.queueArrival('latecomer', 5);
    }, 10000);

    // Mock usage state for preview
    Farm.setUsage({
      liveOutput: 12450,
      liveInput: 3200,
      liveCacheRead: 850000,
      liveMessages: 42,
      todayTokens: 245000,
      todayMessages: 186,
      totalOutput: 3169853,
      totalInput: 277993,
      totalCacheRead: 2280936596,
      totalSessions: 121,
      totalMessages: 98320,
    });

    const SCALE = 2;

    function demo(title, buddies) {
      const h = document.createElement('h2');
      h.textContent = title;
      document.body.appendChild(h);

      const slotW = 40;
      const margin = 15;
      const baseW = Math.max(330, buddies.length * slotW * Scene.PX + margin * 2 * Scene.PX + 90);
      const baseH = 351;

      const c = document.createElement('canvas');
      // Canvas at 2x resolution for sharp rendering
      c.width = baseW * SCALE;
      c.height = baseH * SCALE;
      // Display at 2x size via CSS
      c.style.width = (baseW * SCALE) + 'px';
      c.style.height = (baseH * SCALE) + 'px';
      document.body.appendChild(c);
      const ctx = c.getContext('2d');

      let t = 0;
      function anim() {
        t++;
        ctx.save();
        ctx.setTransform(SCALE, 0, 0, SCALE, 0, 0);
        ctx.clearRect(0, 0, baseW, baseH);
        Scene.drawBackground(ctx, baseW, t);
        Farm.drawFarm(ctx, baseW, t);
        Train.update(t);
        Train.draw(ctx, Math.ceil(baseW / Scene.PX), t);

        const logW = Math.ceil(baseW / Scene.PX);
        const usable = logW - margin * 2;
        const sw = Math.min(40, Math.floor(usable / buddies.length));

        buddies.forEach((b, i) => {
          const sx = margin + i * sw;
          const frame = ((t / 14) | 0) % 4;
          Scene.drawStation(ctx, sx, b.state, t + i * 50);
          Character.draw(ctx, sx, b.state, frame, t + i * 30, i);
          const hc = Character.HOODIE_COLORS[i % Character.HOODIE_COLORS.length];
          Scene.drawNameplate(ctx, (sx + sw / 2) * Scene.PX, b.name, hc.o);
          if (b.detail) {
            SpeechBubble.draw(ctx, b.detail, (sx + 10) * Scene.PX, (Scene.GROUND_Y - 15) * Scene.PX);
          }
        });
        ctx.restore();
        requestAnimationFrame(anim);
      }
      requestAnimationFrame(anim);
    }

    demo('8 Buddies â€” Full village + Farm', [
      { name: '~', state: 'bash', detail: '$ npm test' },
      { name: 'Stock', state: 'writing', detail: '' },
      { name: 'anya', state: 'reading', detail: '' },
      { name: 'kisame', state: 'thinking', detail: '' },
      { name: 'churn', state: 'browsing', detail: '' },
      { name: 'kaonashi', state: 'celebrating', detail: '' },
      { name: 'steropes', state: 'tasking', detail: '' },
      { name: 'Dog', state: 'sleeping', detail: '' },
    ]);
  </script>
</body>
</html>
