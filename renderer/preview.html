<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Claude Buddy Farm Preview — Harvest Moon Style</title>
  <style>
    body { background: #1a1a2e; padding: 20px; font-family: monospace; color: #ccc; }
    h2 { margin: 12px 0 6px; font-size: 14px; }
    canvas { display: block; border-radius: 8px; border: 1px solid #333; image-rendering: pixelated; margin-bottom: 16px; }
    .info { font-size: 11px; color: #888; margin-bottom: 12px; }
  </style>
</head>
<body>
  <script src="speech-bubble.js"></script>
  <script src="scene.js"></script>
  <script src="viewport.js"></script>
  <script src="sprite-manager.js"></script>
  <script src="animal-ai.js"></script>
  <script src="iso-engine.js"></script>
  <script src="iso-entity-manager.js"></script>
  <script src="farm.js"></script>
  <script src="iso-farm.js"></script>
  <script src="iso-train.js"></script>
  <script src="iso-weather.js"></script>
  <script src="iso-tooltip.js"></script>
  <script src="iso-effects.js"></script>
  <script src="iso-ui.js"></script>
  <script src="buddy-ai.js"></script>
  <script src="character.js"></script>
  <script src="train.js"></script>
  <script src="state-machine.js"></script>
  <script>
    // ===== Mock farm state =====
    const mockFarmState = {
      totalEnergy: 2800,
      milestoneReached: 2500,
      plots: [
        { crop: 'carrot', stage: 4, growthProgress: 0 },
        { crop: 'sunflower', stage: 3, growthProgress: 10 },
        { crop: 'watermelon', stage: 4, growthProgress: 0 },
        { crop: 'tomato', stage: 2, growthProgress: 5 },
        { crop: 'corn', stage: 3, growthProgress: 12 },
        { crop: 'carrot', stage: 1, growthProgress: 0 },
        { crop: 'sunflower', stage: 4, growthProgress: 0 },
        { crop: 'pumpkin', stage: 2, growthProgress: 8 },
        { crop: 'watermelon', stage: 3, growthProgress: 15 },
        { crop: null, stage: 0, growthProgress: 0 },
        { crop: null, stage: 0, growthProgress: 0 },
        { crop: null, stage: 0, growthProgress: 0 },
      ],
      animals: {
        chicken: { unlocked: true, homeX: 25 },
        cow: { unlocked: true, homeX: 50 },
        pig: { unlocked: true, homeX: 75 },
        sheep: { unlocked: true, homeX: 40 },
        cat: { unlocked: true, homeX: 60 },
      },
      buildings: {
        well: true,
        barn: true,
        windmill: true,
        market: true,
      },
      unlockedCrops: ['carrot', 'sunflower', 'watermelon', 'tomato', 'corn', 'pumpkin'],
      totalHarvests: 23,
      achievements: [],
    };
    Farm.setState(mockFarmState);

    Farm.setVibe({
      timestamp: new Date().toISOString(),
      vibeScore: 0.78,
      mood: 'productive',
      metrics: { eventsPerMinute: 8.5, errorRate: 0.05, toolDiversity: 6, totalEvents: 42, dominantActivity: 'writing' },
      atmosphere: { skyTint: 'warm', animalMood: 'happy', lampLit: false, groundTint: null },
    });

    Farm.setUsage({
      liveOutput: 12450, liveInput: 3200, liveCacheRead: 850000, liveMessages: 42,
      todayTokens: 245000, todayMessages: 186,
      totalOutput: 3169853, totalInput: 277993, totalCacheRead: 2280936596,
      totalSessions: 121, totalMessages: 98320,
    });

    // ===== Top-Down Farm Demo (Harvest Moon style) =====
    const h1 = document.createElement('h2');
    h1.textContent = 'Top-Down Farm — Harvest Moon Style';
    document.body.appendChild(h1);

    const info = document.createElement('div');
    info.className = 'info';
    info.textContent = 'Arrow keys: pan camera | Mouse wheel: zoom | Hover tiles for highlight';
    document.body.appendChild(info);

    const baseW = 900;
    const baseH = 700;
    const c1 = document.createElement('canvas');
    c1.width = baseW;
    c1.height = baseH;
    c1.style.width = baseW + 'px';
    c1.style.height = baseH + 'px';
    c1.id = 'farm-canvas';
    document.body.appendChild(c1);
    const fCtx = c1.getContext('2d');

    // Load sprites (async, graceful fallback to procedural rendering)
    if (typeof SpriteManager !== 'undefined') {
      SpriteManager.loadAllFromConfig('.').then(({ loaded, failed }) => {
        if (loaded.length > 0) console.log(`[Sprites] Loaded ${loaded.length} sprites`);
        if (failed.length > 0) console.log(`[Sprites] ${failed.length} not found (using procedural fallback)`);
      });
    }

    // Initialize top-down engine + farm
    IsoFarm.init();
    IsoFarm.syncState();

    // Add demo buddies
    const demoBuddies = [
      { id: 'b1', project: 'AIFarm', colorIndex: 0 },
      { id: 'b2', project: 'Stock', colorIndex: 1 },
      { id: 'b3', project: 'kisame', colorIndex: 3 },
    ];
    for (const b of demoBuddies) {
      IsoFarm.syncBuddy(b.id, b.project, b.colorIndex, 'working');
    }

    // Demo: simulate buddy activity events (BuddyAI drives farming animation)
    const eventTypes = ['tool_use', 'text', 'thinking', 'bash_progress', 'tool_use'];
    setInterval(() => {
      const b = demoBuddies[Math.floor(Math.random() * demoBuddies.length)];
      const evt = eventTypes[Math.floor(Math.random() * eventTypes.length)];
      if (typeof BuddyAI !== 'undefined') {
        BuddyAI.onActivity(b.id, evt);
      }
    }, 4000);

    // Demo: periodic harvest with floating reward text
    setInterval(() => {
      const plotIdx = Math.floor(Math.random() * IsoFarm.PLOT_POSITIONS.length);
      const pos = IsoFarm.PLOT_POSITIONS[plotIdx];
      const cropColors = ['#FF8C00', '#FFD700', '#2E8B57', '#FF4444', '#F0E68C', '#FF7518'];
      const color = cropColors[Math.floor(Math.random() * cropColors.length)];
      for (let tc = 0; tc < (pos.width || 1); tc++) {
        IsoEngine.spawnHarvestParticles(pos.col + tc, pos.row, color, 8);
        IsoEngine.spawnHarvestParticles(pos.col + tc, pos.row, '#FFD700', 4);
      }
      // Floating reward text
      if (typeof IsoEffects !== 'undefined') {
        const tokens = Math.floor(500 + Math.random() * 2000);
        IsoEffects.spawnHarvestReward(pos.col + 1, pos.row, tokens);
      }
    }, 3000);

    // Camera state for mouse interaction
    let hoverCol = -1, hoverRow = -1;

    c1.addEventListener('mousemove', (e) => {
      const rect = c1.getBoundingClientRect();
      const mx = e.clientX - rect.left;
      const my = e.clientY - rect.top;
      const grid = IsoEngine.mouseToGrid(mx, my);
      IsoEngine.setHoverTile(grid.col, grid.row);
      if (typeof IsoTooltip !== 'undefined') {
        IsoTooltip.updateHover(grid.col, grid.row, new Map(), []);
      }
    });
    c1.addEventListener('mouseleave', () => {
      IsoEngine.setHoverTile(-1, -1);
    });
    c1.addEventListener('click', (e) => {
      const rect = c1.getBoundingClientRect();
      const mx = e.clientX - rect.left;
      const my = e.clientY - rect.top;
      const grid = IsoEngine.mouseToGrid(mx, my);
      if (typeof IsoUI !== 'undefined') {
        IsoUI.handleClick(grid.col, grid.row);
      }
    });
    c1.addEventListener('wheel', (e) => {
      e.preventDefault();
      const rect = c1.getBoundingClientRect();
      const mx = e.clientX - rect.left;
      const my = e.clientY - rect.top;
      const delta = e.deltaY < 0 ? 1 : -1;
      IsoEngine.zoom(delta, mx / IsoEngine.getZoom(), my / IsoEngine.getZoom());
    }, { passive: false });

    // Arrow key panning
    const farmKeys = {};
    document.addEventListener('keydown', (e) => { farmKeys[e.key] = true; });
    document.addEventListener('keyup', (e) => { farmKeys[e.key] = false; });

    let farmTick = 0;
    function farmLoop() {
      farmTick++;

      // Camera pan
      const PAN_SPEED = 4;
      if (farmKeys['ArrowLeft']) IsoEngine.moveCamera(PAN_SPEED, 0);
      if (farmKeys['ArrowRight']) IsoEngine.moveCamera(-PAN_SPEED, 0);
      if (farmKeys['ArrowUp']) IsoEngine.moveCamera(0, PAN_SPEED);
      if (farmKeys['ArrowDown']) IsoEngine.moveCamera(0, -PAN_SPEED);

      // Update buddy AI (farming/tending behavior)
      if (typeof BuddyAI !== 'undefined') {
        BuddyAI.update(farmTick);
      }

      // Update entities
      IsoEntityManager.update(farmTick);
      IsoEntityManager.syncToEngine();

      // Clear with seasonal sky gradient
      const sky = (typeof IsoWeather !== 'undefined') ? IsoWeather.getSkyGradient() : {};
      const skyGrad = fCtx.createLinearGradient(0, 0, 0, baseH);
      skyGrad.addColorStop(0, sky.skyTop || '#87CEEB');
      skyGrad.addColorStop(0.25, sky.skyMid || '#B8E0F0');
      skyGrad.addColorStop(0.4, sky.grassTop || '#6EBF4E');
      skyGrad.addColorStop(1, sky.grassBot || '#4E9E38');
      fCtx.fillStyle = skyGrad;
      fCtx.fillRect(0, 0, baseW, baseH);

      // Weather
      if (typeof IsoWeather !== 'undefined') {
        const vibe = Farm.getVibe();
        if (vibe) IsoWeather.setMood(vibe.mood, vibe.vibeScore || 0);
        IsoWeather.update(farmTick, baseW, baseH);
      }

      // Update + render particles
      IsoEngine.updateParticles();

      // Render map + entities
      IsoEngine.drawMap(fCtx, baseW, baseH, farmTick);

      // Seasonal ground tint overlay (after tiles, before particles)
      if (typeof IsoWeather !== 'undefined') {
        IsoWeather.drawGroundTint(fCtx, baseW, baseH);
      }

      // Draw particles + floating effects (in zoomed space)
      fCtx.save();
      fCtx.imageSmoothingEnabled = false;
      fCtx.scale(IsoEngine.getZoom(), IsoEngine.getZoom());
      IsoEngine.drawParticles(fCtx);
      if (typeof IsoEffects !== 'undefined') {
        IsoEffects.update();
        IsoEffects.draw(fCtx, baseW / IsoEngine.getZoom(), baseH / IsoEngine.getZoom());
      }
      fCtx.restore();

      // Weather overlay
      if (typeof IsoWeather !== 'undefined') {
        IsoWeather.draw(fCtx, baseW, baseH, farmTick);
      }

      // Tooltips
      if (typeof IsoTooltip !== 'undefined') {
        IsoTooltip.draw(fCtx, baseW, baseH, farmTick);
      }

      // HUD
      IsoFarm.drawHUD(fCtx, baseW, baseH, farmTick);

      // Modal overlay (bulletin board daily summary)
      if (typeof IsoUI !== 'undefined') {
        IsoUI.update();
        IsoUI.draw(fCtx, baseW, baseH, farmTick);
      }

      requestAnimationFrame(farmLoop);
    }
    requestAnimationFrame(farmLoop);

  </script>
</body>
</html>
